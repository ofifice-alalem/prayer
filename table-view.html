<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>العرض الجدولي للصلوات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Cairo', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-arabic">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- User Header -->
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" id="user-avatar"></div>
                    <div>
                        <div class="text-xl font-bold" id="user-name"></div>
                        <div class="text-sm text-gray-600">العرض الجدولي</div>
                    </div>
                </div>
                <button onclick="changeUser()" class="text-sm text-gray-500 hover:text-gray-700">تغيير المستخدم</button>
            </div>
        </div>

        <!-- Header -->
        <div class="text-center mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
                <div class="text-2xl font-bold" id="current-month"></div>
                <div class="text-lg text-gray-600">المرجع السريع</div>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">جدول الصلوات الشهري</h1>
            <p class="text-gray-600">عرض سريع لجميع الصلوات في الشهر</p>
        </div>

        <!-- Navigation -->
        <div class="mb-6 flex justify-center gap-4">
            <a href="prayer-dashboard.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                اللوحة اليومية
            </a>
            <a href="monthly-report.html" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                التقرير الشهري
            </a>
            <button onclick="exportToExcel()" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-700 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 17a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 5a2 2 0 012-2h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V5z"/>
                </svg>
                تصدير Excel
            </button>
        </div>

        <!-- Table Container -->
        <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 overflow-x-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">جدول الصلوات</h2>
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-gray-800 font-bold p-3 text-right">اليوم</th>
                        <th class="text-green-600 font-bold p-3 text-center">الفجر</th>
                        <th class="text-green-600 font-bold p-3 text-center">الظهر</th>
                        <th class="text-green-600 font-bold p-3 text-center">العصر</th>
                        <th class="text-green-600 font-bold p-3 text-center">المغرب</th>
                        <th class="text-green-600 font-bold p-3 text-center">العشاء</th>
                        <th class="text-amber-600 font-bold p-3 text-center">سنة الفجر</th>
                        <th class="text-amber-600 font-bold p-3 text-center">الضحى</th>
                        <th class="text-amber-600 font-bold p-3 text-center">الوتر</th>
                        <th class="text-gray-800 font-bold p-3 text-center">النسبة</th>
                    </tr>
                </thead>
                <tbody id="prayer-table">
                    <!-- Rows will be generated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function getCurrentUser() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'user-select.html';
                return null;
            }
            return currentUser;
        }
        
        function getUserProfile(username) {
            const profile = localStorage.getItem(`user_${username}`);
            return profile ? JSON.parse(profile) : null;
        }
        
        function loadMonthlyData() {
            const currentUser = getCurrentUser();
            if (!currentUser) return {};
            
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            const key = `prayers_${currentUser}_${currentYear}_${currentMonth}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : {};
        }

        function generateTable() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = now.getDate();
            const monthlyData = loadMonthlyData();
            
            const tableBody = document.getElementById('prayer-table');
            tableBody.innerHTML = '';

            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = monthlyData[day] || {};
                const isFutureDay = day > today;
                
                const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => dayData[p]).length;
                const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
                const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
                
                const row = document.createElement('tr');
                const isAllFardComplete = fardCount === 5;
                const isAllNaflComplete = naflCount === 3;
                const rowBgClass = isAllFardComplete ? 'bg-green-50' : '';
                row.className = `border-b border-gray-100 ${isFutureDay ? 'opacity-50' : ''} ${rowBgClass}`;
                
                const dayName = getDayName(day);
                
                row.innerHTML = `
                    <td class="p-3 text-gray-800 font-medium">
                        <div class="font-bold">${day} ${isAllFardComplete && isAllNaflComplete ? '⭐' : ''}</div>
                        <div class="text-xs text-gray-500">${dayName}</div>
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.fajr ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updatePrayer(${day}, 'fajr', this.checked)" 
                               class="w-5 h-5 text-green-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.dhuhr ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updatePrayer(${day}, 'dhuhr', this.checked)" 
                               class="w-5 h-5 text-green-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.asr ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updatePrayer(${day}, 'asr', this.checked)" 
                               class="w-5 h-5 text-green-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.maghrib ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updatePrayer(${day}, 'maghrib', this.checked)" 
                               class="w-5 h-5 text-green-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.isha ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updatePrayer(${day}, 'isha', this.checked)" 
                               class="w-5 h-5 text-green-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData['fajr-sunnah'] ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updatePrayer(${day}, 'fajr-sunnah', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.duha ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updatePrayer(${day}, 'duha', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.witr ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updatePrayer(${day}, 'witr', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center text-gray-800 font-bold">${isFutureDay ? '-' : totalPercentage + '%'}</td>
                `;
                
                tableBody.appendChild(row);
            }
        }

        function updatePrayer(day, prayer, checked) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            const key = `prayers_${currentUser}_${year}_${month}`;
            
            let monthData = JSON.parse(localStorage.getItem(key) || '{}');
            if (!monthData[day]) monthData[day] = {};
            
            monthData[day][prayer] = checked;
            localStorage.setItem(key, JSON.stringify(monthData));
            
            // Update percentage and styling for this row
            const dayData = monthData[day];
            const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => dayData[p]).length;
            const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
            const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
            const isAllFardComplete = fardCount === 5;
            const isAllNaflComplete = naflCount === 3;
            
            const rows = document.querySelectorAll('#prayer-table tr');
            const targetRow = rows[day - 1];
            if (targetRow) {
                const percentageCell = targetRow.querySelector('td:last-child');
                percentageCell.textContent = totalPercentage + '%';
                
                // Update row background
                if (isAllFardComplete) {
                    targetRow.classList.add('bg-green-50');
                } else {
                    targetRow.classList.remove('bg-green-50');
                }
                
                // Update star in day cell
                const dayCell = targetRow.querySelector('td:first-child div:first-child');
                if (dayCell) {
                    const dayNumber = day;
                    dayCell.innerHTML = `${dayNumber} ${isAllFardComplete && isAllNaflComplete ? '⭐' : ''}`;
                }
            }
        }

        function getDayName(day) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const date = new Date(year, month, day);
            const dayNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            return dayNames[date.getDay()];
        }

        function updateCurrentMonth() {
            const now = new Date();
            const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            document.getElementById('current-month').textContent = `${months[now.getMonth()]} ${now.getFullYear()}`;
        }

        function exportToExcel() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            // Show loading state
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> جاري التصدير...';
            btn.disabled = true;
            
            setTimeout(() => {
                const profile = getUserProfile(currentUser);
                const now = new Date();
                const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                const monthName = months[now.getMonth()];
                
                let csvContent = '﻿';
                csvContent += `تقرير الصلاة الشهري\n`;
                csvContent += `المستخدم: ${profile.username}\n`;
                csvContent += `الشهر: ${monthName} ${now.getFullYear()}\n`;
                csvContent += `تاريخ التصدير: ${now.toLocaleDateString('ar-SA')}\n\n`;
                csvContent += 'اليوم,اسم اليوم,الفجر,الظهر,العصر,المغرب,العشاء,سنة الفجر,الضحى,الوتر,النسبة,الحالة\n';
                
                const monthlyData = loadMonthlyData();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const today = now.getDate();
                let completedDays = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayData = monthlyData[day] || {};
                    const dayName = getDayName(day);
                    const isFutureDay = day > today;
                    
                    if (!isFutureDay) {
                        const prayers = {
                            fajr: dayData.fajr ? '✓' : '✗',
                            dhuhr: dayData.dhuhr ? '✓' : '✗',
                            asr: dayData.asr ? '✓' : '✗',
                            maghrib: dayData.maghrib ? '✓' : '✗',
                            isha: dayData.isha ? '✓' : '✗',
                            fajrSunnah: dayData['fajr-sunnah'] ? '✓' : '✗',
                            duha: dayData.duha ? '✓' : '✗',
                            witr: dayData.witr ? '✓' : '✗'
                        };
                        
                        const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => dayData[p]).length;
                        const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
                        const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
                        
                        let status = 'ناقص';
                        if (totalPercentage === 100) status = 'مكتمل ⭐';
                        else if (fardCount === 5) status = 'فرائض مكتملة';
                        else if (totalPercentage >= 50) status = 'جيد';
                        
                        if (totalPercentage === 100) completedDays++;
                        
                        csvContent += `${day},${dayName},${prayers.fajr},${prayers.dhuhr},${prayers.asr},${prayers.maghrib},${prayers.isha},${prayers.fajrSunnah},${prayers.duha},${prayers.witr},${totalPercentage}%,${status}\n`;
                    }
                }
                
                csvContent += `\nملخص الشهر:\n`;
                csvContent += `عدد الأيام المكتملة,${completedDays}\n`;
                csvContent += `عدد الأيام المسجلة,${today}\n`;
                csvContent += `نسبة الإنجاز,${Math.round((completedDays/today)*100)}%\n`;
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `تقرير_الصلاة_${profile.username}_${monthName}_${now.getFullYear()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // Show success message
                showToast('تم تصدير التقرير بنجاح!');
            }, 500);
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function changeUser() {
            localStorage.removeItem('currentUser');
            window.location.href = 'user-select.html';
        }
        
        function applyUserTheme() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const profile = getUserProfile(currentUser);
            if (!profile) return;
            
            document.getElementById('user-name').textContent = profile.username;
            document.getElementById('user-avatar').textContent = profile.avatar;
            document.getElementById('user-avatar').className = `w-12 h-12 bg-${profile.color}-500 rounded-full flex items-center justify-center text-2xl text-white`;
            document.getElementById('current-month').className = `text-2xl font-bold text-${profile.color}-600`;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            applyUserTheme();
            updateCurrentMonth();
            generateTable();
        });
    </script>
</body>
</html>