<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>العرض الجدولي للصلوات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Cairo', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-arabic">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- User Header -->
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" id="user-avatar"></div>
                    <div>
                        <div class="text-xl font-bold" id="user-name"></div>
                        <div class="text-sm text-gray-600">العرض الجدولي</div>
                    </div>
                </div>
                <button onclick="changeUser()" class="text-sm text-gray-500 hover:text-gray-700">تغيير المستخدم</button>
            </div>
        </div>

        <!-- Header -->
        <div class="text-center mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
                <div class="text-2xl font-bold" id="current-month"></div>
                <div class="text-lg text-gray-600">المرجع السريع</div>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">جدول الصلوات الشهري</h1>
            <p class="text-gray-600">عرض سريع لجميع الصلوات في الشهر</p>
        </div>

        <!-- Navigation -->
        <div class="mb-6 flex justify-center gap-4 flex-wrap">
            <a href="prayer-dashboard.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                اللوحة اليومية
            </a>
            <a href="monthly-report.html" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                التقرير الشهري
            </a>
            <a href="missed-rakaat-summary.html" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-700 transition-colors">
                الركعات الفائتة
            </a>
            <a href="missed-prayers-summary.html" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                الصلوات المفقودة
            </a>
            <button onclick="exportToExcel()" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded-lg font-medium hover:from-green-700 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 17a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 5a2 2 0 012-2h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V5z"/>
                </svg>
                تصدير Excel
            </button>
            <button onclick="exportToJSON()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"/>
                </svg>
                تصدير JSON
            </button>
        </div>

        <!-- Table Container -->
        <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 overflow-x-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">جدول الصلوات</h2>
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-gray-800 font-bold p-2 text-center w-12">✅</th>
                        <th class="text-gray-800 font-bold p-3 text-right">اليوم</th>
                        <th class="text-green-600 font-bold p-3 text-center">الفجر<br><span class="text-xs">(2)</span></th>
                        <th class="text-green-600 font-bold p-3 text-center">الظهر<br><span class="text-xs">(4)</span></th>
                        <th class="text-green-600 font-bold p-3 text-center">العصر<br><span class="text-xs">(4)</span></th>
                        <th class="text-green-600 font-bold p-3 text-center">المغرب<br><span class="text-xs">(3)</span></th>
                        <th class="text-green-600 font-bold p-3 text-center">العشاء<br><span class="text-xs">(4)</span></th>
                        <th class="text-amber-600 font-bold p-3 text-center">سنة الفجر</th>
                        <th class="text-amber-600 font-bold p-3 text-center">الضحى</th>
                        <th class="text-amber-600 font-bold p-3 text-center">الوتر</th>
                        <th class="text-gray-800 font-bold p-3 text-center">النسبة</th>
                    </tr>
                </thead>
                <tbody id="prayer-table">
                    <!-- Rows will be generated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function getCurrentUser() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'user-select.html';
                return null;
            }
            return currentUser;
        }
        
        function getUserProfile(username) {
            const profile = localStorage.getItem(`user_${username}`);
            return profile ? JSON.parse(profile) : null;
        }
        
        function loadMonthlyData() {
            const currentUser = getCurrentUser();
            if (!currentUser) return {};
            
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            const key = `prayers_${currentUser}_${currentYear}_${currentMonth}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : {};
        }
        
        function isPrayerCompleted(prayerData) {
            return prayerData && (prayerData === true || prayerData.completed === true);
        }
        
        function getPrayerStatus(prayerData) {
            if (!prayerData || prayerData === false) return { completed: false, missed: 0 };
            if (prayerData === true) return { completed: true, missed: 0 };
            return { completed: prayerData.completed || false, missed: prayerData.missedRakaat || 0 };
        }

        function generateTable() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = now.getDate();
            const monthlyData = loadMonthlyData();
            
            const tableBody = document.getElementById('prayer-table');
            tableBody.innerHTML = '';

            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = monthlyData[day] || {};
                const isFutureDay = day > today;
                
                const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => isPrayerCompleted(dayData[p])).length;
                const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
                const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
                
                const row = document.createElement('tr');
                const isAllFardComplete = fardCount === 5;
                const isAllNaflComplete = naflCount === 3;
                const hasMissedFard = !isFutureDay && fardCount < 5;
                
                // Check if no missed rakaat
                const hasNoMissedRakaat = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].every(p => {
                    const prayerData = dayData[p];
                    return !prayerData || prayerData === true || !prayerData.completed || prayerData.missedRakaat === 0;
                });
                
                let rowBgClass = '';
                const isToday = day === today;
                if (hasMissedFard && !isToday) {
                    rowBgClass = 'bg-red-100';
                } else if (hasMissedFard && isToday) {
                    rowBgClass = 'bg-yellow-50';
                } else if (isAllFardComplete) {
                    rowBgClass = 'bg-green-100';
                }
                
                row.className = `border-b border-gray-100 ${isFutureDay ? 'opacity-50' : ''} ${rowBgClass}`;
                
                const dayName = getDayName(day);
                
                const fardPrayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
                let fardCells = '';
                fardPrayers.forEach(prayer => {
                    const status = getPrayerStatus(dayData[prayer]);
                    const isToday = day === today;
                    let cellContent = '';
                    
                    if (isFutureDay) {
                        cellContent = '<span class="text-gray-400">-</span>';
                    } else if (status.completed && status.missed === 0) {
                        cellContent = '<span class="text-green-600 text-xl">✅</span>';
                    } else if (status.completed && status.missed > 0) {
                        cellContent = `<span class="text-orange-500 text-xl" title="${status.missed} ركعة فائتة">⚠️</span>`;
                    } else if (isToday) {
                        cellContent = '<span class="text-yellow-500 text-xl">⏳</span>';
                    } else {
                        cellContent = '<span class="text-red-500 text-xl">❌</span>';
                    }
                    
                    fardCells += `<td class="p-3 text-center cursor-pointer" onclick="${isFutureDay ? '' : `editPrayer(${day}, '${prayer}')`}">${cellContent}</td>`;
                });
                
                row.innerHTML = `
                    <td class="p-2 text-center w-12">
                        ${isFutureDay ? '<span class="text-gray-400">-</span>' : `<input type="checkbox" ${isAllFardComplete && isAllNaflComplete && hasNoMissedRakaat ? 'checked' : ''} onchange="toggleAllPrayers(${day}, this.checked)" class="w-4 h-4 text-blue-600 rounded">`}
                    </td>
                    <td class="p-3 text-gray-800 font-medium">
                        <div class="font-bold">${day} ${isAllFardComplete && isAllNaflComplete && hasNoMissedRakaat ? '⭐' : ''}</div>
                        <div class="text-xs text-gray-500">${dayName}</div>
                    </td>
                    ${fardCells}
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData['fajr-sunnah'] ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updateNaflPrayer(${day}, 'fajr-sunnah', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.duha ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updateNaflPrayer(${day}, 'duha', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.witr ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updateNaflPrayer(${day}, 'witr', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center text-gray-800 font-bold">${isFutureDay ? '-' : totalPercentage + '%'}</td>
                `;
                
                tableBody.appendChild(row);
            }
        }

        function editPrayer(day, prayer) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const monthlyData = loadMonthlyData();
            const dayData = monthlyData[day] || {};
            const prayerData = dayData[prayer] || { completed: false, missedRakaat: 0 };
            const status = getPrayerStatus(prayerData);
            
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const dayDate = new Date(year, month, day);
            const isFriday = dayDate.getDay() === 5;
            
            const prayerNames = {
                'fajr': 'الفجر (2 ركعة)', 
                'dhuhr': isFriday ? 'الجمعة (2 ركعة)' : 'الظهر (4 ركعات)', 
                'asr': 'العصر (4 ركعات)', 
                'maghrib': 'المغرب (3 ركعات)', 
                'isha': 'العشاء (4 ركعات)'
            };
            const maxRakaat = { 'fajr': 2, 'dhuhr': isFriday ? 2 : 4, 'asr': 4, 'maghrib': 3, 'isha': 4 };
            
            let rakaatOptions = '<option value="0">لا يوجد فوات</option>';
            for (let i = 1; i <= maxRakaat[prayer]; i++) {
                rakaatOptions += `<option value="${i}" ${status.missed === i ? 'selected' : ''}>${i === 1 ? 'ركعة واحدة' : i === 2 ? 'ركعتان' : i + ' ركعات'}</option>`;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-80 max-w-sm mx-4">
                    <h3 class="text-lg font-bold mb-4">${prayerNames[prayer]} - يوم ${day}</h3>
                    <div class="space-y-3">
                        <button class="w-full py-2 px-4 rounded ${status.completed && status.missed === 0 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600'}" id="complete-btn">
                            مكتملة ✅
                        </button>
                        <select class="w-full py-2 px-4 rounded border" id="missed-select">
                            ${rakaatOptions}
                        </select>
                        <div class="flex gap-2 mt-4">
                            <button onclick="savePrayerEdit(${day}, '${prayer}')" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                                حفظ
                            </button>
                            <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400">
                                إلغاء
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
            
            // Add event listeners
            const completeBtn = modal.querySelector('#complete-btn');
            const missedSelect = modal.querySelector('#missed-select');
            
            completeBtn.addEventListener('click', function() {
                if (this.classList.contains('bg-green-500')) {
                    this.className = 'w-full py-2 px-4 rounded bg-gray-200 text-gray-600';
                    missedSelect.value = '0';
                } else {
                    this.className = 'w-full py-2 px-4 rounded bg-green-500 text-white';
                    missedSelect.value = '0';
                }
            });
            
            missedSelect.addEventListener('change', function() {
                if (this.value > 0) {
                    completeBtn.className = 'w-full py-2 px-4 rounded bg-orange-500 text-white';
                } else {
                    completeBtn.className = 'w-full py-2 px-4 rounded bg-gray-200 text-gray-600';
                }
            });
        }
        
        function savePrayerEdit(day, prayer) {
            const modal = window.currentModal;
            const completeBtn = modal.querySelector('#complete-btn');
            const missedSelect = modal.querySelector('#missed-select');
            const isActive = completeBtn.classList.contains('bg-green-500') || completeBtn.classList.contains('bg-orange-500');
            const missedRakaat = parseInt(missedSelect.value);
            
            const currentUser = getCurrentUser();
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            const key = `prayers_${currentUser}_${year}_${month}`;
            
            let monthData = JSON.parse(localStorage.getItem(key) || '{}');
            if (!monthData[day]) monthData[day] = {};
            
            if (isActive && missedRakaat === 0) {
                monthData[day][prayer] = { completed: true, missedRakaat: 0 };
            } else if (missedRakaat > 0) {
                monthData[day][prayer] = { completed: true, missedRakaat: missedRakaat };
            } else {
                monthData[day][prayer] = { completed: false, missedRakaat: 0 };
            }
            
            localStorage.setItem(key, JSON.stringify(monthData));
            closeModal();
            generateTable();
        }
        
        function toggleAllPrayers(day, checked) {
            const dayName = getDayName(day);
            
            // Check current day status to determine actual action
            const currentUser = getCurrentUser();
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            const key = `prayers_${currentUser}_${year}_${month}`;
            const monthData = JSON.parse(localStorage.getItem(key) || '{}');
            const dayData = monthData[day] || {};
            
            const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => isPrayerCompleted(dayData[p])).length;
            const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
            const hasNoMissedRakaat = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].every(p => {
                const prayerData = dayData[p];
                return !prayerData || prayerData === true || !prayerData.completed || prayerData.missedRakaat === 0;
            });
            
            const isCurrentlyComplete = fardCount === 5 && naflCount === 3 && hasNoMissedRakaat;
            const shouldSelect = !isCurrentlyComplete;
            
            const action = shouldSelect ? 'تحديد جميع الصلوات' : 'إلغاء تحديد جميع الصلوات';
            const icon = shouldSelect ? '✅' : '❌';
            const color = shouldSelect ? 'green' : 'red';
            
            showConfirmModal(
                `${action}`,
                `هل تريد ${action} ليوم ${day} - ${dayName}؟`,
                icon,
                color,
                () => {
                    const currentUser = getCurrentUser();
                    if (!currentUser) return;
                    
                    const now = new Date();
                    const month = now.getMonth() + 1;
                    const year = now.getFullYear();
                    const key = `prayers_${currentUser}_${year}_${month}`;
                    
                    let monthData = JSON.parse(localStorage.getItem(key) || '{}');
                    if (!monthData[day]) monthData[day] = {};
                    
                    if (shouldSelect) {
                        // Set all fard prayers as completed
                        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
                            monthData[day][prayer] = { completed: true, missedRakaat: 0 };
                        });
                        
                        // Set all nafl prayers as completed
                        ['fajr-sunnah', 'duha', 'witr'].forEach(prayer => {
                            monthData[day][prayer] = true;
                        });
                    } else {
                        // Clear all prayers
                        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
                            monthData[day][prayer] = { completed: false, missedRakaat: 0 };
                        });
                        
                        ['fajr-sunnah', 'duha', 'witr'].forEach(prayer => {
                            monthData[day][prayer] = false;
                        });
                    }
                    
                    localStorage.setItem(key, JSON.stringify(monthData));
                    generateTable();
                },
                () => {
                    // Reset checkbox if cancelled
                    const checkbox = document.querySelector(`input[onchange*="toggleAllPrayers(${day}"]`);
                    if (checkbox) checkbox.checked = isCurrentlyComplete;
                }
            );
        }
        
        function showConfirmModal(title, message, icon, color, onConfirm, onCancel) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-sm mx-4 border-r-4 border-${color}-500">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">${icon}</div>
                        <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                    </div>
                    <p class="text-gray-600 text-center mb-6">${message}</p>
                    <div class="flex gap-3">
                        <button onclick="confirmAction()" class="flex-1 bg-${color}-600 text-white py-2 rounded-lg hover:bg-${color}-700 transition-colors">
                            تأكيد
                        </button>
                        <button onclick="cancelAction()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                            إلغاء
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentConfirmModal = modal;
            
            window.confirmAction = function() {
                onConfirm();
                closeConfirmModal();
            };
            
            window.cancelAction = function() {
                if (onCancel) onCancel();
                closeConfirmModal();
            };
        }
        
        function closeConfirmModal() {
            if (window.currentConfirmModal) {
                document.body.removeChild(window.currentConfirmModal);
                window.currentConfirmModal = null;
            }
        }
        
        function closeModal() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
        }
        
        function updateNaflPrayer(day, prayer, checked) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            const key = `prayers_${currentUser}_${year}_${month}`;
            
            let monthData = JSON.parse(localStorage.getItem(key) || '{}');
            if (!monthData[day]) monthData[day] = {};
            
            monthData[day][prayer] = checked;
            localStorage.setItem(key, JSON.stringify(monthData));
            
            // Update percentage and styling for this row
            const dayData = monthData[day];
            const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => isPrayerCompleted(dayData[p])).length;
            const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
            const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
            const isAllFardComplete = fardCount === 5;
            const isAllNaflComplete = naflCount === 3;
            const hasMissedFard = fardCount < 5;
            const today = now.getDate();
            const isToday = day === today;
            
            const rows = document.querySelectorAll('#prayer-table tr');
            const targetRow = rows[day - 1];
            if (targetRow) {
                const percentageCell = targetRow.querySelector('td:last-child');
                percentageCell.textContent = totalPercentage + '%';
                
                // Update row background
                targetRow.classList.remove('bg-green-50', 'bg-red-50', 'bg-green-100', 'bg-red-100', 'bg-yellow-50');
                if (hasMissedFard && !isToday) {
                    targetRow.classList.add('bg-red-100');
                } else if (hasMissedFard && isToday) {
                    targetRow.classList.add('bg-yellow-50');
                } else if (isAllFardComplete) {
                    targetRow.classList.add('bg-green-100');
                }
                

                
                // Check if no missed rakaat for update
                const hasNoMissedRakaatUpdate = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].every(p => {
                    const prayerData = dayData[p];
                    return !prayerData || prayerData === true || !prayerData.completed || prayerData.missedRakaat === 0;
                });
                
                // Update star in day cell
                const dayCell = targetRow.querySelector('td:first-child div:first-child');
                if (dayCell) {
                    const dayNumber = day;
                    dayCell.innerHTML = `${dayNumber} ${isAllFardComplete && isAllNaflComplete && hasNoMissedRakaatUpdate ? '⭐' : ''}`;
                }
            }
        }

        function getDayName(day) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const date = new Date(year, month, day);
            const dayNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            return dayNames[date.getDay()];
        }

        function updateCurrentMonth() {
            const now = new Date();
            const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            document.getElementById('current-month').textContent = `${months[now.getMonth()]} ${now.getFullYear()}`;
        }

        function exportToExcel() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            // Show loading state
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> جاري التصدير...';
            btn.disabled = true;
            
            setTimeout(() => {
                const profile = getUserProfile(currentUser);
                const now = new Date();
                const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                const monthName = months[now.getMonth()];
                
                let csvContent = '﻿';
                csvContent += `تقرير الصلاة الشهري\n`;
                csvContent += `المستخدم: ${profile.username}\n`;
                csvContent += `الشهر: ${monthName} ${now.getFullYear()}\n`;
                csvContent += `تاريخ التصدير: ${now.toLocaleDateString('ar-SA')}\n\n`;
                csvContent += 'اليوم,اسم اليوم,الفجر,الظهر,العصر,المغرب,العشاء,سنة الفجر,الضحى,الوتر,النسبة,الحالة\n';
                
                const monthlyData = loadMonthlyData();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const today = now.getDate();
                let completedDays = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayData = monthlyData[day] || {};
                    const dayName = getDayName(day);
                    const isFutureDay = day > today;
                    
                    if (!isFutureDay) {
                        const prayers = {};
                        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
                            const status = getPrayerStatus(dayData[prayer]);
                            if (status.completed && status.missed === 0) prayers[prayer] = '✓';
                            else if (status.completed && status.missed > 0) prayers[prayer] = `⚠(${status.missed})`;
                            else prayers[prayer] = '✗';
                        });
                        
                        prayers.fajrSunnah = dayData['fajr-sunnah'] ? '✓' : '✗';
                        prayers.duha = dayData.duha ? '✓' : '✗';
                        prayers.witr = dayData.witr ? '✓' : '✗';
                        
                        const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => isPrayerCompleted(dayData[p])).length;
                        const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
                        const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
                        
                        let status = 'ناقص';
                        if (totalPercentage === 100) status = 'مكتمل ⭐';
                        else if (fardCount === 5) status = 'فرائض مكتملة';
                        else if (totalPercentage >= 50) status = 'جيد';
                        
                        if (totalPercentage === 100) completedDays++;
                        
                        csvContent += `${day},${dayName},${prayers.fajr},${prayers.dhuhr},${prayers.asr},${prayers.maghrib},${prayers.isha},${prayers.fajrSunnah},${prayers.duha},${prayers.witr},${totalPercentage}%,${status}\n`;
                    }
                }
                
                csvContent += `\nملخص الشهر:\n`;
                csvContent += `عدد الأيام المكتملة,${completedDays}\n`;
                csvContent += `عدد الأيام المسجلة,${today}\n`;
                csvContent += `نسبة الإنجاز,${Math.round((completedDays/today)*100)}%\n`;
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `تقرير_الصلاة_${profile.username}_${monthName}_${now.getFullYear()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // Show success message
                showToast('تم تصدير التقرير بنجاح!');
            }, 500);
        }
        
        function exportToJSON() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const profile = getUserProfile(currentUser);
            const now = new Date();
            
            // Collect all prayer data for the user
            const userData = {
                username: profile.username,
                exportDate: now.toISOString(),
                prayerData: {}
            };
            
            // Get all months data
            for (let key in localStorage) {
                if (key.startsWith(`prayers_${currentUser}_`)) {
                    userData.prayerData[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            
            const jsonData = JSON.stringify(userData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `بيانات_الصلاة_${profile.username}_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('تم تصدير البيانات بنجاح!');
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function changeUser() {
            localStorage.removeItem('currentUser');
            window.location.href = 'user-select.html';
        }
        
        function applyUserTheme() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const profile = getUserProfile(currentUser);
            if (!profile) return;
            
            document.getElementById('user-name').textContent = profile.username;
            document.getElementById('user-avatar').textContent = profile.avatar;
            document.getElementById('user-avatar').className = `w-12 h-12 bg-${profile.color}-500 rounded-full flex items-center justify-center text-2xl text-white`;
            document.getElementById('current-month').className = `text-2xl font-bold text-${profile.color}-600`;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            applyUserTheme();
            updateCurrentMonth();
            generateTable();
        });
    </script>
</body>
</html>