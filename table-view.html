<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠ Ù„Ù„ØµÙ„ÙˆØ§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Cairo', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-arabic">
    <style>
        @media (max-width: 500px) {
            .mobile-fixed { position: fixed; top: 0; left: 0; right: 0; z-index: 30; }
            .mobile-content { margin-top: 80px; }
        }
    </style>
    <div class="container mx-auto px-2 sm:px-4 py-2 sm:py-8 max-w-7xl">
        <!-- User Header -->
        <div class="bg-white rounded-2xl shadow-lg p-2 sm:p-4 mb-6 mobile-fixed">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="w-10 sm:w-12 h-10 sm:h-12 rounded-full flex items-center justify-center text-xl sm:text-2xl" id="user-avatar"></div>
                    <div>
                        <div class="text-lg sm:text-xl font-bold" id="user-name"></div>
                        <div class="text-xs sm:text-sm text-gray-600">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠ</div>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-2 border-gray-200 rounded-xl px-5 py-2" style="padding: 5px 10px 5px 20px; border-radius: 10px; border: 2px solid #eee;">
                    <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                        <span class="text-lg">ğŸ </span>
                    </div>
                    <span>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
                </button>
            </div>
        </div>

        <!-- Header -->
        <div class="text-center mb-8 mobile-content">
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
                <div class="text-2xl font-bold" id="current-month"></div>
                <div class="text-lg text-gray-600">Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ</h1>
            <p class="text-gray-600">Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„ÙˆØ§Øª ÙÙŠ Ø§Ù„Ø´Ù‡Ø±</p>
        </div>



        <!-- Table Container -->
        <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 overflow-x-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙ„ÙˆØ§Øª</h2>
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-gray-800 font-bold p-2 text-center w-12">âœ…</th>
                        <th class="text-gray-800 font-bold p-3 text-right">Ø§Ù„ÙŠÙˆÙ…</th>
                        <th class="text-green-600 font-bold p-3 text-center">Ø§Ù„ÙØ¬Ø±<br><span class="text-xs">(2)</span></th>
                        <th class="text-green-600 font-bold p-3 text-center">Ø§Ù„Ø¸Ù‡Ø±<br><span class="text-xs">(4)</span></th>
                        <th class="text-green-600 font-bold p-3 text-center">Ø§Ù„Ø¹ØµØ±<br><span class="text-xs">(4)</span></th>
                        <th class="text-green-600 font-bold p-3 text-center">Ø§Ù„Ù…ØºØ±Ø¨<br><span class="text-xs">(3)</span></th>
                        <th class="text-green-600 font-bold p-3 text-center">Ø§Ù„Ø¹Ø´Ø§Ø¡<br><span class="text-xs">(4)</span></th>
                        <th class="text-amber-600 font-bold p-3 text-center">Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±</th>
                        <th class="text-amber-600 font-bold p-3 text-center">Ø§Ù„Ø¶Ø­Ù‰</th>
                        <th class="text-amber-600 font-bold p-3 text-center">Ø§Ù„ÙˆØªØ±</th>
                        <th class="text-gray-800 font-bold p-3 text-center">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                    </tr>
                </thead>
                <tbody id="prayer-table">
                    <!-- Rows will be generated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function getCurrentUser() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'user-select.html';
                return null;
            }
            return currentUser;
        }
        
        function getUserProfile(username) {
            const profile = localStorage.getItem(`user_${username}`);
            return profile ? JSON.parse(profile) : null;
        }
        
        function loadMonthlyData() {
            const currentUser = getCurrentUser();
            if (!currentUser) return {};
            
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            const key = `prayers_${currentUser}_${currentYear}_${currentMonth}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : {};
        }
        
        function isPrayerCompleted(prayerData) {
            return prayerData && (prayerData === true || prayerData.completed === true);
        }
        
        function getPrayerStatus(prayerData) {
            if (!prayerData || prayerData === false) return { completed: false, missed: 0 };
            if (prayerData === true) return { completed: true, missed: 0 };
            return { completed: prayerData.completed || false, missed: prayerData.missedRakaat || 0 };
        }

        function generateTable() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = now.getDate();
            const monthlyData = loadMonthlyData();
            
            const tableBody = document.getElementById('prayer-table');
            tableBody.innerHTML = '';

            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = monthlyData[day] || {};
                const isFutureDay = day > today;
                
                const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => isPrayerCompleted(dayData[p])).length;
                const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
                const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
                
                const row = document.createElement('tr');
                const isAllFardComplete = fardCount === 5;
                const isAllNaflComplete = naflCount === 3;
                const hasMissedFard = !isFutureDay && fardCount < 5;
                
                // Check if no missed rakaat
                const hasNoMissedRakaat = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].every(p => {
                    const prayerData = dayData[p];
                    return !prayerData || prayerData === true || !prayerData.completed || prayerData.missedRakaat === 0;
                });
                
                let rowBgClass = '';
                const isToday = day === today;
                if (hasMissedFard && !isToday) {
                    rowBgClass = 'bg-red-100';
                } else if (hasMissedFard && isToday) {
                    rowBgClass = 'bg-yellow-50';
                } else if (isAllFardComplete) {
                    rowBgClass = 'bg-green-100';
                }
                
                row.className = `border-b border-gray-100 ${isFutureDay ? 'opacity-50' : ''} ${rowBgClass}`;
                
                const dayName = getDayName(day);
                
                const fardPrayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
                let fardCells = '';
                fardPrayers.forEach(prayer => {
                    const status = getPrayerStatus(dayData[prayer]);
                    const isToday = day === today;
                    let cellContent = '';
                    
                    if (isFutureDay) {
                        cellContent = '<span class="text-gray-400">-</span>';
                    } else if (status.completed && status.missed === 0) {
                        cellContent = '<span class="text-green-600 text-xl">âœ…</span>';
                    } else if (status.completed && status.missed > 0) {
                        cellContent = `<span class="text-orange-500 text-xl" title="${status.missed} Ø±ÙƒØ¹Ø© ÙØ§Ø¦ØªØ©">âš ï¸</span>`;
                    } else if (isToday) {
                        cellContent = '<span class="text-yellow-500 text-xl">â³</span>';
                    } else {
                        cellContent = '<span class="text-red-500 text-xl">âŒ</span>';
                    }
                    
                    fardCells += `<td class="p-3 text-center cursor-pointer" onclick="${isFutureDay ? '' : `editPrayer(${day}, '${prayer}')`}">${cellContent}</td>`;
                });
                
                row.innerHTML = `
                    <td class="p-2 text-center w-12">
                        ${isFutureDay ? '<span class="text-gray-400">-</span>' : `<input type="checkbox" ${isAllFardComplete && isAllNaflComplete && hasNoMissedRakaat ? 'checked' : ''} onchange="toggleAllPrayers(${day}, this.checked)" class="w-4 h-4 text-blue-600 rounded">`}
                    </td>
                    <td class="p-3 text-gray-800 font-medium">
                        <div class="font-bold">${day} ${isAllFardComplete && isAllNaflComplete && hasNoMissedRakaat ? 'â­' : ''}</div>
                        <div class="text-xs text-gray-500">${dayName}</div>
                    </td>
                    ${fardCells}
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData['fajr-sunnah'] ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updateNaflPrayer(${day}, 'fajr-sunnah', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.duha ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updateNaflPrayer(${day}, 'duha', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" ${dayData.witr ? 'checked' : ''} ${isFutureDay ? 'disabled' : ''} 
                               onchange="updateNaflPrayer(${day}, 'witr', this.checked)" 
                               class="w-5 h-5 text-amber-600 rounded">
                    </td>
                    <td class="p-3 text-center text-gray-800 font-bold">${isFutureDay ? '-' : totalPercentage + '%'}</td>
                `;
                
                tableBody.appendChild(row);
            }
        }

        function editPrayer(day, prayer) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const monthlyData = loadMonthlyData();
            const dayData = monthlyData[day] || {};
            const prayerData = dayData[prayer] || { completed: false, missedRakaat: 0 };
            const status = getPrayerStatus(prayerData);
            
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const dayDate = new Date(year, month, day);
            const isFriday = dayDate.getDay() === 5;
            
            const prayerNames = {
                'fajr': 'Ø§Ù„ÙØ¬Ø± (2 Ø±ÙƒØ¹Ø©)', 
                'dhuhr': isFriday ? 'Ø§Ù„Ø¬Ù…Ø¹Ø© (2 Ø±ÙƒØ¹Ø©)' : 'Ø§Ù„Ø¸Ù‡Ø± (4 Ø±ÙƒØ¹Ø§Øª)', 
                'asr': 'Ø§Ù„Ø¹ØµØ± (4 Ø±ÙƒØ¹Ø§Øª)', 
                'maghrib': 'Ø§Ù„Ù…ØºØ±Ø¨ (3 Ø±ÙƒØ¹Ø§Øª)', 
                'isha': 'Ø§Ù„Ø¹Ø´Ø§Ø¡ (4 Ø±ÙƒØ¹Ø§Øª)'
            };
            const maxRakaat = { 'fajr': 2, 'dhuhr': isFriday ? 2 : 4, 'asr': 4, 'maghrib': 3, 'isha': 4 };
            
            let rakaatOptions = '<option value="0">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§Øª</option>';
            for (let i = 1; i <= maxRakaat[prayer]; i++) {
                rakaatOptions += `<option value="${i}" ${status.missed === i ? 'selected' : ''}>${i === 1 ? 'Ø±ÙƒØ¹Ø© ÙˆØ§Ø­Ø¯Ø©' : i === 2 ? 'Ø±ÙƒØ¹ØªØ§Ù†' : i + ' Ø±ÙƒØ¹Ø§Øª'}</option>`;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-80 max-w-sm mx-4">
                    <h3 class="text-lg font-bold mb-4">${prayerNames[prayer]} - ÙŠÙˆÙ… ${day}</h3>
                    <div class="space-y-3">
                        <button class="w-full py-2 px-4 rounded ${status.completed && status.missed === 0 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600'}" id="complete-btn">
                            Ù…ÙƒØªÙ…Ù„Ø© âœ…
                        </button>
                        <select class="w-full py-2 px-4 rounded border" id="missed-select">
                            ${rakaatOptions}
                        </select>
                        <div class="flex gap-2 mt-4">
                            <button onclick="savePrayerEdit(${day}, '${prayer}')" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                                Ø­ÙØ¸
                            </button>
                            <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
            
            // Add event listeners
            const completeBtn = modal.querySelector('#complete-btn');
            const missedSelect = modal.querySelector('#missed-select');
            
            completeBtn.addEventListener('click', function() {
                if (this.classList.contains('bg-green-500')) {
                    this.className = 'w-full py-2 px-4 rounded bg-gray-200 text-gray-600';
                    missedSelect.value = '0';
                } else {
                    this.className = 'w-full py-2 px-4 rounded bg-green-500 text-white';
                    missedSelect.value = '0';
                }
            });
            
            missedSelect.addEventListener('change', function() {
                if (this.value > 0) {
                    completeBtn.className = 'w-full py-2 px-4 rounded bg-orange-500 text-white';
                } else {
                    completeBtn.className = 'w-full py-2 px-4 rounded bg-gray-200 text-gray-600';
                }
            });
        }
        
        function savePrayerEdit(day, prayer) {
            const modal = window.currentModal;
            const completeBtn = modal.querySelector('#complete-btn');
            const missedSelect = modal.querySelector('#missed-select');
            const isActive = completeBtn.classList.contains('bg-green-500') || completeBtn.classList.contains('bg-orange-500');
            const missedRakaat = parseInt(missedSelect.value);
            
            const currentUser = getCurrentUser();
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            const key = `prayers_${currentUser}_${year}_${month}`;
            
            let monthData = JSON.parse(localStorage.getItem(key) || '{}');
            if (!monthData[day]) monthData[day] = {};
            
            if (isActive && missedRakaat === 0) {
                monthData[day][prayer] = { completed: true, missedRakaat: 0 };
            } else if (missedRakaat > 0) {
                monthData[day][prayer] = { completed: true, missedRakaat: missedRakaat };
            } else {
                monthData[day][prayer] = { completed: false, missedRakaat: 0 };
            }
            
            localStorage.setItem(key, JSON.stringify(monthData));
            closeModal();
            generateTable();
        }
        
        function toggleAllPrayers(day, checked) {
            const dayName = getDayName(day);
            
            // Check current day status to determine actual action
            const currentUser = getCurrentUser();
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            const key = `prayers_${currentUser}_${year}_${month}`;
            const monthData = JSON.parse(localStorage.getItem(key) || '{}');
            const dayData = monthData[day] || {};
            
            const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => isPrayerCompleted(dayData[p])).length;
            const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
            const hasNoMissedRakaat = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].every(p => {
                const prayerData = dayData[p];
                return !prayerData || prayerData === true || !prayerData.completed || prayerData.missedRakaat === 0;
            });
            
            const isCurrentlyComplete = fardCount === 5 && naflCount === 3 && hasNoMissedRakaat;
            const shouldSelect = !isCurrentlyComplete;
            
            const action = shouldSelect ? 'ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„ÙˆØ§Øª' : 'Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„ÙˆØ§Øª';
            const icon = shouldSelect ? 'âœ…' : 'âŒ';
            const color = shouldSelect ? 'green' : 'red';
            
            showConfirmModal(
                `${action}`,
                `Ù‡Ù„ ØªØ±ÙŠØ¯ ${action} Ù„ÙŠÙˆÙ… ${day} - ${dayName}ØŸ`,
                icon,
                color,
                () => {
                    const currentUser = getCurrentUser();
                    if (!currentUser) return;
                    
                    const now = new Date();
                    const month = now.getMonth() + 1;
                    const year = now.getFullYear();
                    const key = `prayers_${currentUser}_${year}_${month}`;
                    
                    let monthData = JSON.parse(localStorage.getItem(key) || '{}');
                    if (!monthData[day]) monthData[day] = {};
                    
                    if (shouldSelect) {
                        // Set all fard prayers as completed
                        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
                            monthData[day][prayer] = { completed: true, missedRakaat: 0 };
                        });
                        
                        // Set all nafl prayers as completed
                        ['fajr-sunnah', 'duha', 'witr'].forEach(prayer => {
                            monthData[day][prayer] = true;
                        });
                    } else {
                        // Clear all prayers
                        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
                            monthData[day][prayer] = { completed: false, missedRakaat: 0 };
                        });
                        
                        ['fajr-sunnah', 'duha', 'witr'].forEach(prayer => {
                            monthData[day][prayer] = false;
                        });
                    }
                    
                    localStorage.setItem(key, JSON.stringify(monthData));
                    generateTable();
                },
                () => {
                    // Reset checkbox if cancelled
                    const checkbox = document.querySelector(`input[onchange*="toggleAllPrayers(${day}"]`);
                    if (checkbox) checkbox.checked = isCurrentlyComplete;
                }
            );
        }
        
        function showConfirmModal(title, message, icon, color, onConfirm, onCancel) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-sm mx-4 border-r-4 border-${color}-500">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">${icon}</div>
                        <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                    </div>
                    <p class="text-gray-600 text-center mb-6">${message}</p>
                    <div class="flex gap-3">
                        <button onclick="confirmAction()" class="flex-1 bg-${color}-600 text-white py-2 rounded-lg hover:bg-${color}-700 transition-colors">
                            ØªØ£ÙƒÙŠØ¯
                        </button>
                        <button onclick="cancelAction()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentConfirmModal = modal;
            
            window.confirmAction = function() {
                onConfirm();
                closeConfirmModal();
            };
            
            window.cancelAction = function() {
                if (onCancel) onCancel();
                closeConfirmModal();
            };
        }
        
        function closeConfirmModal() {
            if (window.currentConfirmModal) {
                document.body.removeChild(window.currentConfirmModal);
                window.currentConfirmModal = null;
            }
        }
        
        function closeModal() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
        }
        
        function updateNaflPrayer(day, prayer, checked) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            const key = `prayers_${currentUser}_${year}_${month}`;
            
            let monthData = JSON.parse(localStorage.getItem(key) || '{}');
            if (!monthData[day]) monthData[day] = {};
            
            monthData[day][prayer] = checked;
            localStorage.setItem(key, JSON.stringify(monthData));
            
            // Update percentage and styling for this row
            const dayData = monthData[day];
            const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => isPrayerCompleted(dayData[p])).length;
            const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
            const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
            const isAllFardComplete = fardCount === 5;
            const isAllNaflComplete = naflCount === 3;
            const hasMissedFard = fardCount < 5;
            const today = now.getDate();
            const isToday = day === today;
            
            const rows = document.querySelectorAll('#prayer-table tr');
            const targetRow = rows[day - 1];
            if (targetRow) {
                const percentageCell = targetRow.querySelector('td:last-child');
                percentageCell.textContent = totalPercentage + '%';
                
                // Update row background
                targetRow.classList.remove('bg-green-50', 'bg-red-50', 'bg-green-100', 'bg-red-100', 'bg-yellow-50');
                if (hasMissedFard && !isToday) {
                    targetRow.classList.add('bg-red-100');
                } else if (hasMissedFard && isToday) {
                    targetRow.classList.add('bg-yellow-50');
                } else if (isAllFardComplete) {
                    targetRow.classList.add('bg-green-100');
                }
                

                
                // Check if no missed rakaat for update
                const hasNoMissedRakaatUpdate = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].every(p => {
                    const prayerData = dayData[p];
                    return !prayerData || prayerData === true || !prayerData.completed || prayerData.missedRakaat === 0;
                });
                
                // Update star in day cell
                const dayCell = targetRow.querySelector('td:first-child div:first-child');
                if (dayCell) {
                    const dayNumber = day;
                    dayCell.innerHTML = `${dayNumber} ${isAllFardComplete && isAllNaflComplete && hasNoMissedRakaatUpdate ? 'â­' : ''}`;
                }
            }
        }

        function getDayName(day) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const date = new Date(year, month, day);
            const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
            return dayNames[date.getDay()];
        }

        function updateCurrentMonth() {
            const now = new Date();
            const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            document.getElementById('current-month').textContent = `${months[now.getMonth()]} ${now.getFullYear()}`;
        }

        function exportToExcel() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            // Show loading state
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...';
            btn.disabled = true;
            
            setTimeout(() => {
                const profile = getUserProfile(currentUser);
                const now = new Date();
                const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
                const monthName = months[now.getMonth()];
                
                let csvContent = 'ï»¿';
                csvContent += `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠ\n`;
                csvContent += `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${profile.username}\n`;
                csvContent += `Ø§Ù„Ø´Ù‡Ø±: ${monthName} ${now.getFullYear()}\n`;
                csvContent += `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${now.toLocaleDateString('ar-SA')}\n\n`;
                csvContent += 'Ø§Ù„ÙŠÙˆÙ…,Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…,Ø§Ù„ÙØ¬Ø±,Ø§Ù„Ø¸Ù‡Ø±,Ø§Ù„Ø¹ØµØ±,Ø§Ù„Ù…ØºØ±Ø¨,Ø§Ù„Ø¹Ø´Ø§Ø¡,Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±,Ø§Ù„Ø¶Ø­Ù‰,Ø§Ù„ÙˆØªØ±,Ø§Ù„Ù†Ø³Ø¨Ø©,Ø§Ù„Ø­Ø§Ù„Ø©\n';
                
                const monthlyData = loadMonthlyData();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const today = now.getDate();
                let completedDays = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayData = monthlyData[day] || {};
                    const dayName = getDayName(day);
                    const isFutureDay = day > today;
                    
                    if (!isFutureDay) {
                        const prayers = {};
                        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
                            const status = getPrayerStatus(dayData[prayer]);
                            if (status.completed && status.missed === 0) prayers[prayer] = 'âœ“';
                            else if (status.completed && status.missed > 0) prayers[prayer] = `âš (${status.missed})`;
                            else prayers[prayer] = 'âœ—';
                        });
                        
                        prayers.fajrSunnah = dayData['fajr-sunnah'] ? 'âœ“' : 'âœ—';
                        prayers.duha = dayData.duha ? 'âœ“' : 'âœ—';
                        prayers.witr = dayData.witr ? 'âœ“' : 'âœ—';
                        
                        const fardCount = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].filter(p => isPrayerCompleted(dayData[p])).length;
                        const naflCount = ['fajr-sunnah', 'duha', 'witr'].filter(p => dayData[p]).length;
                        const totalPercentage = Math.round(((fardCount + naflCount) / 8) * 100);
                        
                        let status = 'Ù†Ø§Ù‚Øµ';
                        if (totalPercentage === 100) status = 'Ù…ÙƒØªÙ…Ù„ â­';
                        else if (fardCount === 5) status = 'ÙØ±Ø§Ø¦Ø¶ Ù…ÙƒØªÙ…Ù„Ø©';
                        else if (totalPercentage >= 50) status = 'Ø¬ÙŠØ¯';
                        
                        if (totalPercentage === 100) completedDays++;
                        
                        csvContent += `${day},${dayName},${prayers.fajr},${prayers.dhuhr},${prayers.asr},${prayers.maghrib},${prayers.isha},${prayers.fajrSunnah},${prayers.duha},${prayers.witr},${totalPercentage}%,${status}\n`;
                    }
                }
                
                csvContent += `\nÙ…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±:\n`;
                csvContent += `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©,${completedDays}\n`;
                csvContent += `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©,${today}\n`;
                csvContent += `Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²,${Math.round((completedDays/today)*100)}%\n`;
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØµÙ„Ø§Ø©_${profile.username}_${monthName}_${now.getFullYear()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // Show success message
                showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
            }, 500);
        }
        
        function exportToJSON() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const profile = getUserProfile(currentUser);
            const now = new Date();
            
            // Collect all prayer data for the user
            const userData = {
                username: profile.username,
                exportDate: now.toISOString(),
                prayerData: {}
            };
            
            // Get all months data
            for (let key in localStorage) {
                if (key.startsWith(`prayers_${currentUser}_`)) {
                    userData.prayerData[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            
            const jsonData = JSON.stringify(userData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„ØµÙ„Ø§Ø©_${profile.username}_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function changeUser() {
            localStorage.removeItem('currentUser');
            window.location.href = 'user-select.html';
        }
        
        function applyUserTheme() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const profile = getUserProfile(currentUser);
            if (!profile) return;
            
            document.getElementById('user-name').textContent = profile.username;
            document.getElementById('user-avatar').textContent = profile.avatar;
            document.getElementById('user-avatar').className = `w-12 h-12 bg-${profile.color}-500 rounded-full flex items-center justify-center text-2xl text-white`;
            document.getElementById('current-month').className = `text-2xl font-bold text-${profile.color}-600`;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            applyUserTheme();
            updateCurrentMonth();
            generateTable();
        });
    </script>
    <script src="sidebar.js"></script>
</body>
</html>